#' Get preliminary results
#'
#' Function to genereate preliminary results for the TERN application,
#' including sample size calculations
#' @param use.saved Logical. If TRUE the results are loaded from a
#'     local file generated by running this function on the nagratal
#'     server. Defaults to FALSE.
get_preliminary_results <- function(use.saved = FALSE) {
    assertthat::assert_that(is.logical(use.saved) & length(use.saved) == 1)
    if (use.saved) {
        preliminary.results <- readRDS("preliminary-results.Rds")
    } else {
        ## TERN
        ## Import data
        tern <- readr::read_csv(paste0(Sys.getenv("DATA_DIR"), "tern/current/dataset.csv"))

        ## Import codebook
        codebook.arguments <- lapply(c("URL", "UID", "USERNAME", "PASSWORD"),
                                     function(x) Sys.getenv(paste0("KOBO_", x)))
        codebook <- do.call(noacsr::kobo_get_project_codebook, codebook.arguments)

        ## Prepare data
        tern <- prepare_data(tern, codebook)
        tern$study <- "TERN"

        ## Define basic results
        arrival.dates <- tern %>% pull(incident__date_of_arrival) %>% sort()
        format_date <- function(date) paste0(month(date[1], label = TRUE, abbr = FALSE), " ", year(date[1]))
        preliminary.results <- list()
        preliminary.results$start.date <- format_date(arrival.dates[1])
        preliminary.results$end.date <- format_date(rev(arrival.dates)[1])
        n.no.consent <-  list("11542" = 40,
                              "44805" = 10,
                              "55356" = 43,
                              "78344" = 3,
                              "95846" = 9, 
                              "88456" = 0, # To be updated
                              "10263" = 2)
        preliminary.results$recruitment.rate <- nrow(tern)/(nrow(tern) + sum(unlist(n.no.consent)))

        ## Estimate composite outcome
        in.hospital.mortality <- tern$outcomes__discharge_alive == "Yes"
        tern$in.hospital.mortality <- in.hospital.mortality
        n.lost.to.follow.up <- sum(is.na(tern$in.hospital.mortality))
        preliminary.results$rate.lost.to.follow.up <- n.lost.to.follow.up/nrow(tern)
        icc.in.hospital.mortality <- estimate_icc("in.hospital.mortality", "id__reg_hospital_id", tern)
        labelled::var_label(tern$in.hospital.mortality) <- "In-hospital mortality"
        confined.to.bed <- tern$outcomes__eq5dm == "I am confined to bed"
        tern$confined.to.bed <- confined.to.bed
        labelled::var_label(tern$confined.to.bed) <- "Confined to bed"
        extreme.pain.discomfort <- tern$outcomes__eq5dpd == "I have extreme pain or discomfort"
        tern$extreme.pain.discomfort <- extreme.pain.discomfort
        labelled::var_label(tern$extreme.pain.discomfort) <- "Extreme pain or discomfort"
        unable.bath.dress <- tern$outcomes__eq5dsc == "I am unable to bathe or dress myself"
        tern$unable.bath.dress <- unable.bath.dress
        labelled::var_label(tern$unable.bath.dress) <- "Unable to bathe or dress oneself"
        unable.usual.activities <- tern$outcomes__eq5dua == "I am unable to perform my usual activities"
        tern$unable.usual.activities <- unable.usual.activities
        labelled::var_label(tern$unable.usual.activities) <- "Unable to perform usual activities"
        poor.functional.outcome <- confined.to.bed |
            extreme.pain.discomfort |
            unable.bath.dress |
            unable.usual.activities
        tern$poor.functional.outcome <- poor.functional.outcome
        tern$composite.outcome <- tern$poor.functional.outcome | tern$in.hospital.mortality
        labelled::var_label(tern$composite.outcome) <- "Composite endpoint"
        preliminary.results$tern.patients <- nrow(tern)
        
        ## Add delay
        tern$delay <- as.numeric(with(tern, difftime(incident__date_of_arrival, incident__date_of_injury, units = "hours")))

        ## Estimate missing data
        rates.missing.data <- unlist(lapply(tern, function(column) round(sum(is.na(column)/length(column) * 100))))
        rates.relevant.missing.data <- rates.missing.data[c("patinfo__pt_age", "patinfo__pt_gender", "incident__moi", "interventions__admitted", "in.hospital.mortality")]
        preliminary.results$rates.missing.data <- rates.relevant.missing.data
        preliminary.results$mean.missing.data <- mean(rates.relevant.missing.data)

        ## Create smaller pilot dataset
        tern <- tern[, c("study", "id__reg_hospital_id", "patinfo__pt_age", "delay", "interventions__admitted", "poor.functional.outcome", "composite.outcome", "in.hospital.mortality", "patinfo__pt_gender")]
        tern.new.names <- c("study", "centre", "age", "delay", "admitted", "poor.functional.outcome", "composite.outcome", "in.hospital.mortality", "sex")
        names(tern) <- tern.new.names
        tern$admitted <- tern$admitted == "Yes"
        tern$sex <- factor(tern$sex, levels = c("Female", "Male"))

        ## TITCO
        titco <- noacsr::import_csv_from_github("https://raw.githubusercontent.com/titco/titco-I/master/titco-I-full-dataset-v1.csv")
        titco$study <- "TITCO"
        titco$in.hospital.mortality <- titco$died == "Yes"
        titco$centre <- titco$hos
        titco$age <- as.numeric(titco$age)
        titco$doi.toi <- with(titco, paste(doi, toi))
        titco$doi.toi[grep("NA", titco$doi.toi)] <- NA
        titco$doar.toar <- with(titco, paste(doar, toar))
        titco$doar.toar[grep("NA", titco$doar.toar)] <- NA
        titco$delay <- as.numeric(with(titco, difftime(as.POSIXct(doar.toar), as.POSIXct(doi.toi), units = "hours")))
        titco$admitted <- TRUE
        titco <- titco[, c("study", "centre", "age", "delay", "admitted", "in.hospital.mortality", "sex")]

        ## TTRIS
        ttris <- readr::read_csv(paste0(Sys.getenv("DATA_DIR"), "ttris/current/dataset.csv"))
        ttris$study <- "TTRIS"
        ttris$admitted <- ttris$doa != 0 & ttris$doa != 999
        ttris$in.hospital.mortality <- ttris$hd == 1
        ttris$toi[ttris$toi == "999"] <- NA
        ttris$doar[ttris$doar == "999"] <- NA
        ttris$toar[ttris$toar == "999"] <- NA
        ttris$doi.toi <- with(ttris, paste(doi, toi))
        ttris$doi.toi[grep("NA", ttris$doi.toi)] <- NA
        ttris$doar.toar <- with(ttris, paste(doar, toar))
        ttris$doar.toar[grep("NA", ttris$doar.toar)] <- NA
        ttris$delay <- as.numeric(with(ttris, difftime(as.POSIXct(doar.toar), as.POSIXct(doi.toi), units = "hours")))
        ttris <- ttris[, c("study", "centre", "age", "delay", "admitted", "in.hospital.mortality", "sex")]
        ttris$sex <- factor(ttris$sex, levels = c(0, 1), labels = c("Female", "Male"))

        ## TAFT
        taft <- readr::read_csv(paste0(Sys.getenv("DATA_DIR"), "taft/current/dataset.csv"))
        taft$study <- "TAFT"
        taft <- taft[!is.na(taft$centre) & !is.na(taft$hd) & taft$retro == 0, ]
        taft$in.hospital.mortality <- taft$hd == 1
        taft$doi[taft$doi == "999" | taft$doi == "22"] <- NA
        taft$toi[taft$toi == "999"] <- NA
        taft$doar[taft$doar == "999"] <- NA
        taft$toar[taft$toar == "999"] <- NA
        taft$doi.toi <- with(taft, paste(doi, toi))
        taft$doi.toi[grep("NA", taft$doi.toi)] <- NA
        taft$doar.toar <- with(taft, paste(doar, toar))
        taft$doar.toar[grep("NA", taft$doar.toar)] <- NA
        taft$delay <- as.numeric(with(taft, difftime(as.POSIXct(doar.toar), as.POSIXct(doi.toi), units = "hours")))
        taft$poor.functional.outcome <- with(taft, eq5dpd == 2 | eq5dad == 2 | eq5dsc == 2 | eq5dm == 2)
        taft$composite.outcome <- taft$poor.functional.outcome | taft$in.hospital.mortality
        taft$admitted <- TRUE
        taft <- taft[, c("study", "centre", "age", "delay", "admitted", "poor.functional.outcome", "composite.outcome", "in.hospital.mortality", "sex")]
        taft$sex <- factor(taft$sex, levels = c(0, 1), labels = c("Female", "Male"))
        
        ## Merge datasets
        all.data <- dplyr::bind_rows(tern, titco, ttris, taft)
        preliminary.results$number.total.patients <- nrow(all.data)

        ## Find out how many fit eligibility criteria
        all.data$eligible <- with(all.data, (age >= 15 & !is.na(age)) & (admitted & !is.na(admitted)) & (delay < 48 & !is.na(delay)))
        preliminary.results$number.eligible.patients <- sum(all.data$eligible)

        ## Subset eligible patients
        eligible.data <- all.data[all.data$eligible, ]

        ## Calculate percent males and females
        preliminary.results$rate.males <- mean(eligible.data$sex == "Male", na.rm = TRUE)
        preliminary.results$rate.females <- mean(eligible.data$sex == "Female", na.rm = TRUE)

        ## Calculate in-hosital mortality
        preliminary.results$rate.in.hospital.mortality <- mean(eligible.data$in.hospital.mortality, na.rm = TRUE)
        preliminary.results$rate.in.hospital.mortality.males <- mean(eligible.data$in.hospital.mortality[eligible.data$sex == "Male"], na.rm = TRUE)
        preliminary.results$rate.in.hospital.mortality.females <- mean(eligible.data$in.hospital.mortality[eligible.data$sex == "Female"], na.rm = TRUE)

        ## Celculate outcome rates per study 
        rates.per.study <- lapply(split(eligible.data, eligible.data$study), function(study.data) {
            outcomes <- setNames(nm = c("in.hospital.mortality",
                                        "poor.functional.outcome",
                                        "composite.outcome"))
            outcome.rates <- lapply(outcomes, function(outcome) {
                mean(study.data[, outcome], na.rm = TRUE)
            })
            return (outcome.rates)
        })
        preliminary.results$rates.per.study <- rates.per.study

        ## Save results
        saveRDS(preliminary.results, "preliminary-results.Rds")
    }
    
    ## Return results
    return (preliminary.results)
}
